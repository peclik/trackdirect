!function(i){if("function"==typeof define&&define.amd)define(["leaflet"],i);else if("undefined"!=typeof module)module.exports=i(require("leaflet"));else{if(void 0===window.L)throw Error("Leaflet must be loaded first");i(window.L)}}(function(i){var t="polyline-measure-unicode-icon",e="MacIntel"===navigator.platform;return i.Control.PolylineMeasure=i.Control.extend({options:{position:"topleft",unit:"kilometres",useSubunits:!0,clearMeasurementsOnStop:!0,showBearings:!1,bearingTextIn:"In",bearingTextOut:"Out",tooltipTextFinish:"Click to <b>finish line</b><br>",tooltipTextDelete:"Press SHIFT-key and click to <b>delete point</b>",tooltipTextMove:"Click and drag to <b>move point</b><br>",tooltipTextResume:"<br>Press "+(e?"?":"CTRL-key")+" and click to <b>resume line</b>",tooltipTextAdd:"Press "+(e?"?":"CTRL-key")+" and click to <b>add point</b>",measureControlTitleOn:"Turn on PolylineMeasure",measureControlTitleOff:"Turn off PolylineMeasure",measureControlLabel:"&#8614;",measureControlClasses:[],showClearControl:!1,clearControlTitle:"Clear Measurements",clearControlLabel:"&times;",clearControlClasses:[],showUnitControl:!1,unitControlUnits:["kilometres","landmiles","nauticalmiles"],unitControlTitle:{text:"Change Units",kilometres:"kilometres",landmiles:"land miles",nauticalmiles:"nautical miles"},unitControlLabel:{metres:"m",kilometres:"km",feet:"ft",landmiles:"mi",nauticalmiles:"nm"},unitControlClasses:[],tempLine:{color:"#00f",weight:2},fixedLine:{color:"#006",weight:2},arrow:{color:"#000"},startCircle:{color:"#000",weight:1,fillColor:"#0f0",fillOpacity:1,radius:3},intermedCircle:{color:"#000",weight:1,fillColor:"#ff0",fillOpacity:1,radius:3},currentCircle:{color:"#000",weight:1,fillColor:"#f0f",fillOpacity:1,radius:6},endCircle:{color:"#000",weight:1,fillColor:"#f00",fillOpacity:1,radius:3}},_arcpoints:99,_circleNr:-1,_lineNr:-1,_createControl:function(t,e,o,r,s,n){var l=document.createElement("a");return l.innerHTML=t,l.setAttribute("title",e),o.forEach(function(i){l.classList.add(i)}),i.DomEvent.on(l,"click",s,n),r.appendChild(l),l},onAdd:function(e){var o=this;e.on("movestart ",function(){o._mapdragging=!0}),this._container=document.createElement("div"),this._container.classList.add("leaflet-bar"),i.DomEvent.disableClickPropagation(this._container);var r=this.options.measureControlTitleOn,s=this.options.measureControlLabel,n=this.options.measureControlClasses;if(-1!=s.indexOf("&")&&n.push(t),this._arrPolylines=[],this._measureControl=this._createControl(s,r,n,this._container,this._toggleMeasure,this),this._defaultControlBgColor=this._measureControl.style.backgroundColor,this._measureControl.setAttribute("id","polyline-measure-control"),this.options.showClearControl){var r=this.options.clearControlTitle,s=this.options.clearControlLabel,n=this.options.clearControlClasses;-1!=s.indexOf("&")&&n.push(t),this._clearMeasureControl=this._createControl(s,r,n,this._container,this._clearAllMeasurements,this),this._clearMeasureControl.classList.add("polyline-measure-clearControl")}if(this.options.showUnitControl&&this.options.unitControlUnits.length>1){var s=this.options.unitControlLabel[this.options.unit],r=this.options.unitControlTitle.text+" ["+this.options.unitControlTitle[this.options.unit]+"]",n=this.options.unitControlClasses;this._unitControl=this._createControl(s,r,n,this._container,this._changeUnit,this),this._unitControl.setAttribute("id","unitControlId")}return this._container},onRemove:function(){this._measuring&&this._toggleMeasure()},_saveNonpolylineEvents:function(){this._nonpolylineTargets=this._map._targets,void 0!==this._polylineTargets?this._map._targets=this._polylineTargets:this._map._targets={}},_savePolylineEvents:function(){this._polylineTargets=this._map._targets,this._map._targets=this._nonpolylineTargets},_toggleMeasure:function(){this._measuring=!this._measuring,this._measuring?(this._mapdragging=!1,this._saveNonpolylineEvents(),this._measureControl.classList.add("polyline-measure-controlOnBgColor"),this._measureControl.style.backgroundColor=this.options.backgroundColor,this._measureControl.title=this.options.measureControlTitleOff,this._oldCursor=this._map._container.style.cursor,this._map._container.style.cursor="crosshair",this._doubleClickZoom=this._map.doubleClickZoom.enabled(),this._map.doubleClickZoom.disable(),this._layerPaint||(this._layerPaint=i.layerGroup().addTo(this._map)),this._map.on("mousemove",this._mouseMove,this),this._map.on("click",this._mouseClick,this),i.DomEvent.on(document,"keydown",this._onKeyDown,this),this._resetPathVariables()):(this._savePolylineEvents(),this._measureControl.classList.remove("polyline-measure-controlOnBgColor"),this._measureControl.style.backgroundColor=this._defaultControlBgColor,this._measureControl.title=this.options.measureControlTitleOn,this._map._container.style.cursor=this._oldCursor,this._map.off("mousemove",this._mouseMove,this),this._map.off("click",this._mouseClick,this),this._map.off("mousemove",this._resumeFirstpointMousemove,this),this._map.off("click",this._resumeFirstpointClick,this),this._map.off("mousemove",this._dragCircleMousemove,this),this._map.off("mouseup",this._dragCircleMouseup,this),i.DomEvent.off(document,"keydown",this._onKeyDown,this),this._doubleClickZoom&&this._map.doubleClickZoom.enable(),this.options.clearMeasurementsOnStop&&this._layerPaint&&this._clearAllMeasurements(),0!==this._cntCircle&&this._finishPolylinePath()),this._map.fire("polylinemeasure:toggle",{status:this._measuring})},_clearAllMeasurements:function(){void 0!==this._cntCircle&&0!==this._cntCircle&&this._finishPolylinePath(),this._layerPaint&&this._layerPaint.clearLayers(),this._arrPolylines=[],this._map.fire("polylinemeasure:clear")},_changeUnit:function(){let i=(this.options.unitControlUnits.indexOf(this.options.unit)+1)%this.options.unitControlUnits.length;this.options.unit=this.options.unitControlUnits[i],this._unitControl.innerHTML=this.options.unitControlLabel[this.options.unit],this._unitControl.title=this.options.unitControlTitle.text+" ["+this.options.unitControlTitle[this.options.unit]+"]",this._currentLine&&this._computeDistance(this._currentLine),this._arrPolylines.map(this._computeDistance.bind(this))},_computeDistance:function(i){var t=0;i.circleCoords.map((function(e,o){if(o>=1){var r=i.circleCoords[o-1].distanceTo(i.circleCoords[o]);t+=r,this._updateTooltip(i.tooltips[o],i.tooltips[o-1],t,r,i.circleCoords[o-1],i.circleCoords[o])}}).bind(this))},_onKeyDown:function(i){if(27===i.keyCode){if(!0===this._resumeFirstpointFlag){this._resumeFirstpointFlag=!1;var t=this._lineNr;this._map.off("mousemove",this._resumeFirstpointMousemove,this),this._map.off("click",this._resumeFirstpointClick,this),this._layerPaint.removeLayer(this._rubberlinePath2),this._layerPaint.removeLayer(this._tooltipNew),this._arrPolylines[t].circleMarkers[0].setStyle(this.options.startCircle);var e="",o=0;!0===this.options.showBearings&&(e=this.options.bearingTextIn+":---\xb0<br>"+this.options.bearingTextOut+":---\xb0"),e+='<div class="polyline-measure-tooltip-difference">+0</div>',e+='<div class="polyline-measure-tooltip-total">0</div>',this._arrPolylines[t].tooltips[0]._icon.innerHTML=e,this._arrPolylines[t].tooltips.map((function(i,e){if(e>=1){var r=this._arrPolylines[t].circleCoords[e-1].distanceTo(this._arrPolylines[t].circleCoords[e]),s=this._arrPolylines[t].circleCoords[e-1],n=this._arrPolylines[t].circleCoords[e];o+=r;var l=this._arrPolylines[t].tooltips[e-1];this._updateTooltip(i,l,o,r,s,n)}}).bind(this)),this._map.on("mousemove",this._mouseMove,this);return}this._currentLine?this._finishPolylinePath(i):this._toggleMeasure()}},_getDistance:function(i){var t,e=i;return"nauticalmiles"===this.options.unit?(t=this.options.unitControlLabel.nauticalmiles,e=e>=185200?(e/1852).toFixed(0):e>=18520?(e/1852).toFixed(1):e>=1852?(e/1852).toFixed(2):(e/1852).toFixed(3)):"landmiles"===this.options.unit?(t=this.options.unitControlLabel.landmiles,e>=160934.4?e=(e/1609.344).toFixed(0):e>=16093.44?e=(e/1609.344).toFixed(1):e>=1609.344?e=(e/1609.344).toFixed(2):this.options.useSubunits?(e=(e/.3048).toFixed(0),t=this.options.unitControlLabel.feet):e=(e/1609.344).toFixed(4)):(t=this.options.unitControlLabel.kilometres,e>=1e5?e=(e/1e3).toFixed(0):e>=1e4?e=(e/1e3).toFixed(1):e>=1e3?e=(e/1e3).toFixed(2):this.options.useSubunits?(e=e.toFixed(1),t=this.options.unitControlLabel.metres):e=(e/1e3).toFixed(4)),{value:e,unit:t}},_polylineArc:function(i,t){function e(i){var t=Math.sin((1-i)*a)/Math.sin(a),e=Math.sin(i*a)/Math.sin(a),o=t*Math.cos(r)*Math.cos(s)+e*Math.cos(n)*Math.cos(l),c=t*Math.cos(r)*Math.sin(s)+e*Math.cos(n)*Math.sin(l),h=180/Math.PI*Math.atan2(t*Math.sin(r)+e*Math.sin(n),Math.sqrt(Math.pow(o,2)+Math.pow(c,2))),p=180/Math.PI*Math.atan2(c,o),u=p-180*s/Math.PI;function m(i){return Math[i>0?"floor":"ceil"](i)}return u<0?p-=360*m((u-180)/360):p-=360*m((u+180)/360),[h,p]}var o,r=i.lat,s=i.lng,n=t.lat,l=t.lng;r=r*Math.PI/180,s=s*Math.PI/180;var a=2*Math.asin(Math.sqrt(Math.pow(Math.sin((r-(n=n*Math.PI/180))/2),2)+Math.cos(r)*Math.cos(n)*Math.pow(Math.sin((s-(l=l*Math.PI/180))/2),2)));return 0===a?[[r,s]]:function i(t){for(var o=[],r=1/(t-1),s=0;s<t;s++){var n=e(r*s);o.push(n)}return o}(this._arcpoints)},_updateTooltip:function(i,t,e,o,r,s){var n=function(i,t,e){var o=i.lat/180*Math.PI,r=t.lat/180*Math.PI,s=i.lng/180*Math.PI,n=t.lng/180*Math.PI,l=Math.sin(n-s)*Math.cos(r),a=Math.cos(o)*Math.sin(r)-Math.sin(o)*Math.cos(r)*Math.cos(n-s);if("inbound"===e)var c=(180*Math.atan2(l,a)/Math.PI+180).toFixed(0);else var c=(180*Math.atan2(l,a)/Math.PI+360).toFixed(0);return c%360},l=n(s,r,"inbound"),a=n(r,s,"outbound"),c=this._getDistance(e),h=this._getDistance(o),p="";if(h.value>0&&(!0===this.options.showBearings&&(p=this.options.bearingTextIn+": "+l+"\xb0<br>"+this.options.bearingTextOut+":---\xb0"),p+='<div class="polyline-measure-tooltip-difference">+'+h.value+"&nbsp;"+h.unit+"</div>"),p+='<div class="polyline-measure-tooltip-total">'+c.value+"&nbsp;"+c.unit+"</div>",i._icon.innerHTML=p,!0===this.options.showBearings&&t){var u=t._icon.innerHTML,m=RegExp(this.options.bearingTextOut+".*\xb0"),d=u.replace(m,this.options.bearingTextOut+": "+a+"\xb0");t._icon.innerHTML=d}},_drawArrow:function(t){var e=Math.trunc(t.length/2);if(t.length%2==0)var o=t[e-1],r=t[e],s=r[1]-o[1],n=r[0]-o[0],l=[o[0]+n/2,o[1]+s/2];else var o=t[e-1],r=t[e+1],s=r[1]-o[1],n=r[0]-o[0],l=t[e];var a=i.divIcon({className:"",iconSize:[16,16],iconAnchor:[8,8],html:"<div style = 'color:"+this.options.arrow.color+"; font-size: 16px; line-height: 16px; vertical-align:top; transform: rotate("+-(57.29578*Math.atan2(n,s))+"deg)'>&#x27a4;</div>"}),c=i.marker(l,{icon:a,zIndexOffset:-50}).addTo(this._layerPaint);return this._currentLine||c.bindTooltip(this.options.tooltipTextAdd,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),c.on("click",this._clickedArrow,this),c},_mouseMove:function(i){var t=i.latlng;if(this._map.on("click",this._mouseClick,this),t&&this._currentLine){var e=this._currentLine.circleCoords.last();this._rubberlinePath.setLatLngs(this._polylineArc(e,t));var o=this._currentLine.tooltips.last(),r=this._currentLine.tooltips.slice(-2,-1)[0];o.setLatLng(t);var s=t.distanceTo(e);this._updateTooltip(o,r,this._currentLine.distance+s,s,e,t)}},_startLine:function(t){var e=i.divIcon({className:"polyline-measure-tooltip",iconAnchor:[-4,-4]}),o=function(){return this.slice(-1)[0]};this._rubberlinePath=i.polyline([],{color:this.options.tempLine.color,weight:this.options.tempLine.weight,interactive:!1,dashArray:"8,8"}).addTo(this._layerPaint).bringToBack();var r=this;this._currentLine={id:0,circleCoords:[],circleMarkers:[],arrowMarkers:[],tooltips:[],distance:0,polylinePath:i.polyline([],{color:this.options.fixedLine.color,weight:this.options.fixedLine.weight,interactive:!1}).addTo(this._layerPaint).bringToBack(),handleMarkers:function(t){var e=this.circleMarkers.last();e&&(e.bindTooltip(r.options.tooltipTextDelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),e.off("click",r._finishPolylinePath,r),1===this.circleMarkers.length?e.setStyle(r.options.startCircle):e.setStyle(r.options.intermedCircle));var o=new i.CircleMarker(t,r.options.currentCircle).addTo(r._layerPaint);o.bindTooltip(r.options.tooltipTextFinish+r.options.tooltipTextDelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),o.cntLine=r._currentLine.id,o.cntCircle=r._cntCircle,r._cntCircle++,o.on("mousedown",r._dragCircle,r),o.on("click",r._finishPolylinePath,r),this.circleMarkers.push(o)},getNewToolTip:function(t){return i.marker(t,{icon:e,interactive:!1})},addPoint:function(i){var t=this.circleCoords.last();if(!(t&&t.equals(i))){if(this.circleCoords.push(i),this.circleCoords.length>1){var e=r._polylineArc(t,i),o=r._drawArrow(e);this.circleCoords.length>2&&e.shift(),this.polylinePath.setLatLngs(this.polylinePath.getLatLngs().concat(e)),o.cntLine=r._currentLine.id,o.cntArrow=r._cntCircle-1,r._currentLine.arrowMarkers.push(o);var s=t.distanceTo(i);this.distance+=s;var n=r._currentLine.tooltips.last(),l=r._currentLine.tooltips.slice(-1,-2)[0];r._updateTooltip(n,l,this.distance,s,t,i)}n&&n.setLatLng(i);var a=this.getNewToolTip(i);a.addTo(r._layerPaint),this.tooltips.push(a),this.handleMarkers(i)}},finalize:function(){if(r._layerPaint.removeLayer(this.tooltips.last()),this.tooltips.pop(),r._layerPaint.removeLayer(r._rubberlinePath),this.circleCoords.length>1){this.tooltips.last()._icon.classList.add("polyline-measure-tooltip-end");var i=this.circleMarkers.last();i.setStyle(r.options.endCircle),i.unbindTooltip(),r._currentLine.circleMarkers.map(function(i){i.bindTooltip(r.options.tooltipTextMove+r.options.tooltipTextDelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"})}),r._currentLine.circleMarkers[0].bindTooltip(r.options.tooltipTextMove+r.options.tooltipTextDelete+r.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),i.bindTooltip(r.options.tooltipTextMove+r.options.tooltipTextDelete+r.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),r._currentLine.arrowMarkers.map(function(i){i.bindTooltip(r.options.tooltipTextAdd,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"})}),i.off("click",r._finishPolylinePath,r),i.on("click",r._resumePolylinePath,r),r._arrPolylines[this.id]=this}else r._layerPaint.removeLayer(this.circleMarkers.last()),r._layerPaint.removeLayer(this.tooltips.last());r._resetPathVariables()}};var s=i.marker(t,{icon:e,interactive:!1});s.addTo(this._layerPaint);var n="";!0===this.options.showBearings&&(n=this.options.bearingTextIn+":---\xb0<br>"+this.options.bearingTextOut+":---\xb0"),n+='<div class="polyline-measure-tooltip-difference">+0</div>',n+='<div class="polyline-measure-tooltip-total">0</div>',s._icon.innerHTML=n,this._currentLine.tooltips.push(s),this._currentLine.circleCoords.last=o,this._currentLine.tooltips.last=o,this._currentLine.circleMarkers.last=o,this._currentLine.id=this._arrPolylines.length},_mouseClick:function(i){!(!i.latlng||this._finishCircleScreencoords&&this._finishCircleScreencoords.equals(i.containerPoint))&&(this._currentLine||this._mapdragging||(this._startLine(i.latlng),this._map.fire("polylinemeasure:start",this._currentLine)),this._mapdragging?this._mapdragging=!1:(this._currentLine.addPoint(i.latlng),this._map.fire("polylinemeasure:add",i),this._map.fire("polylinemeasure:change",this._currentLine)))},_finishPolylinePath:function(i){this._map.fire("polylinemeasure:finish",this._currentLine),this._currentLine.finalize(),i&&(this._finishCircleScreencoords=i.containerPoint)},_resumePolylinePath:function(t){if(!0===t.originalEvent.ctrlKey||!0===t.originalEvent.metaKey){this._currentLine=this._arrPolylines[t.target.cntLine],this._rubberlinePath=i.polyline([],{color:this.options.tempLine.color,weight:this.options.tempLine.weight,interactive:!1,dashArray:"8,8"}).addTo(this._layerPaint).bringToBack(),this._currentLine.tooltips.last()._icon.classList.remove("polyline-measure-tooltip-end");var e=this._currentLine.getNewToolTip(t.latlng);e.addTo(this._layerPaint),this._currentLine.tooltips.push(e),this._currentLine.circleMarkers.last().unbindTooltip(),this._currentLine.circleMarkers.last().bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._currentLine.circleMarkers.last().setStyle(this.options.currentCircle),this._cntCircle=this._currentLine.circleCoords.length,this._map.fire("polylinemeasure:resume",this._currentLine)}},_resetPathVariables:function(){this._cntCircle=0,this._currentLine=null},_clickedArrow:function(t){if(t.originalEvent.ctrlKey||t.originalEvent.metaKey){var e=t.target.cntLine,o=t.target.cntArrow;this._arrPolylines[e].arrowMarkers[o].removeFrom(this._layerPaint);var r=new i.CircleMarker(t.latlng,this.options.intermedCircle).addTo(this._layerPaint);r.cntLine=e,r.on("mousedown",this._dragCircle,this),r.bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._arrPolylines[e].circleMarkers.splice(o+1,0,r),this._arrPolylines[e].circleMarkers.map(function(i,t){i.cntCircle=t}),this._arrPolylines[e].circleCoords.splice(o+1,0,t.latlng);var s=this._arrPolylines[e].polylinePath.getLatLngs(),n=this._polylineArc(this._arrPolylines[e].circleCoords[o],t.latlng);n.pop();var l=this._polylineArc(t.latlng,this._arrPolylines[e].circleCoords[o+2]);Array.prototype.splice.apply(s,[o*(this._arcpoints-1),this._arcpoints].concat(n,l)),this._arrPolylines[e].polylinePath.setLatLngs(s);var a=this._drawArrow(n);this._arrPolylines[e].arrowMarkers[o]=a,a=this._drawArrow(l),this._arrPolylines[e].arrowMarkers.splice(o+1,0,a),this._arrPolylines[e].arrowMarkers.map(function(i,t){i.cntLine=e,i.cntArrow=t}),this._tooltipNew=i.marker(t.latlng,{icon:i.divIcon({className:"polyline-measure-tooltip",iconAnchor:[-4,-4]}),interactive:!1}),this._tooltipNew.addTo(this._layerPaint),this._arrPolylines[e].tooltips.splice(o+1,0,this._tooltipNew);var c=0;this._arrPolylines[e].tooltips.map((function(i,t){if(t>=1){var o=this._arrPolylines[e].circleCoords[t-1].distanceTo(this._arrPolylines[e].circleCoords[t]),r=this._arrPolylines[e].circleCoords[t-1],s=this._arrPolylines[e].circleCoords[t];c+=o;var n=this._arrPolylines[e].tooltips[t-1];this._updateTooltip(i,n,c,o,r,s)}}).bind(this)),this._map.fire("polylinemeasure:insert",t),this._map.fire("polylinemeasure:change",this._arrPolylines[this._lineNr])}},_dragCircleMouseup:function(){0===this._circleNr||this._circleNr===this._arrPolylines[this._lineNr].circleCoords.length-1?this._e1.target.bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}):this._e1.target.bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._resetPathVariables(),this._map.off("mousemove",this._dragCircleMousemove,this),this._map.dragging.enable(),this._map.on("mousemove",this._mouseMove,this),this._map.off("mouseup",this._dragCircleMouseup,this),this._map.fire("polylinemeasure:move",this._e1),this._map.fire("polylinemeasure:change",this._arrPolylines[this._lineNr])},_dragCircleMousemove:function(t){var e=t.latlng.lat,o=t.latlng.lng,r=e-this._mouseStartingLat,s=o-this._mouseStartingLng,n=i.latLng(this._circleStartingLat+r,this._circleStartingLng+s),l=this._arcpoints,a=this._e1.target.cntLine;this._lineNr=a;var c=this._e1.target.cntCircle;this._circleNr=c,this._e1.target.setLatLng(n),this._e1.target.unbindTooltip(),this._arrPolylines[a].circleCoords[c]=n;var h=this._arrPolylines[a].polylinePath.getLatLngs();if(c>=1){var p=this._polylineArc(this._arrPolylines[a].circleCoords[c-1],n);Array.prototype.splice.apply(h,[(c-1)*(l-1),l].concat(p));var u=this._drawArrow(p);u.cntLine=a,u.cntArrow=c-1,this._arrPolylines[a].arrowMarkers[c-1].removeFrom(this._layerPaint),this._arrPolylines[a].arrowMarkers[c-1]=u}if(c<this._arrPolylines[a].circleCoords.length-1){var m=this._polylineArc(n,this._arrPolylines[a].circleCoords[c+1]);Array.prototype.splice.apply(h,[c*(l-1),l].concat(m)),(u=this._drawArrow(m)).cntLine=a,u.cntArrow=c,this._arrPolylines[a].arrowMarkers[c].removeFrom(this._layerPaint),this._arrPolylines[a].arrowMarkers[c]=u}this._arrPolylines[a].polylinePath.setLatLngs(h),c>=0&&this._arrPolylines[a].tooltips[c].setLatLng(n);var d=0;this._arrPolylines[a].tooltips.map((function(i,t){if(t>=1){var e=this._arrPolylines[a].circleCoords[t-1].distanceTo(this._arrPolylines[a].circleCoords[t]),o=this._arrPolylines[a].circleCoords[t-1],r=this._arrPolylines[a].circleCoords[t];d+=e,this._arrPolylines[a].distance=d;var s=this._arrPolylines[a].tooltips[t-1];this._updateTooltip(i,s,d,e,o,r)}}).bind(this)),this._map.on("mouseup",this._dragCircleMouseup,this)},_resumeFirstpointMousemove:function(i){var t=this._lineNr;this._map.on("click",this._resumeFirstpointClick,this);var e=i.latlng;this._rubberlinePath2.setLatLngs(this._polylineArc(e,currentCircleCoords)),this._tooltipNew.setLatLng(e);var o=0,r=e.distanceTo(this._arrPolylines[t].circleCoords[0]),s=this._arrPolylines[t].circleCoords[0];o+=r;var n=this._tooltipNew,l=this._arrPolylines[t].tooltips[0];this._updateTooltip(l,n,o,r,e,s),this._arrPolylines[t].tooltips.map((function(i,e){if(e>=1){var r=this._arrPolylines[t].circleCoords[e-1].distanceTo(this._arrPolylines[t].circleCoords[e]),s=this._arrPolylines[t].circleCoords[e-1],n=this._arrPolylines[t].circleCoords[e];o+=r;var l=this._arrPolylines[t].tooltips[e-1];this._updateTooltip(i,l,o,r,s,n)}}).bind(this))},_resumeFirstpointClick:function(t){var e=this._lineNr;this._resumeFirstpointFlag=!1,this._map.off("mousemove",this._resumeFirstpointMousemove,this),this._map.off("click",this._resumeFirstpointClick,this),this._layerPaint.removeLayer(this._rubberlinePath2),this._arrPolylines[e].circleMarkers[0].setStyle(this.options.intermedCircle),this._arrPolylines[e].circleMarkers[0].unbindTooltip(),this._arrPolylines[e].circleMarkers[0].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"});var o=new i.CircleMarker(t.latlng,this.options.startCircle).addTo(this._layerPaint);o.cntLine=e,o.cntCircle=0,o.on("mousedown",this._dragCircle,this),o.bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._arrPolylines[e].circleMarkers.unshift(o),this._arrPolylines[e].circleMarkers.map(function(i,t){i.cntCircle=t}),this._arrPolylines[e].circleCoords.unshift(t.latlng);var r=this._polylineArc(t.latlng,currentCircleCoords),s=this._drawArrow(r);this._arrPolylines[e].arrowMarkers.unshift(s),this._arrPolylines[e].arrowMarkers.map(function(i,t){i.cntLine=e,i.cntArrow=t}),r.pop(),this._arrPolylines[e].polylinePath.setLatLngs(r.concat(this._arrPolylines[e].polylinePath.getLatLngs())),this._arrPolylines[e].tooltips.unshift(this._tooltipNew),this._map.on("mousemove",this._mouseMove,this)},_dragCircle:function(t){var e=this._arcpoints;if(t.originalEvent.ctrlKey||t.originalEvent.metaKey){if(this._map.off("click",this._mouseClick,this),0===t.target.cntCircle){this._resumeFirstpointFlag=!0,this._lineNr=t.target.cntLine;var o=this._lineNr;this._circleNr=t.target.cntCircle,currentCircleCoords=t.latlng,this._arrPolylines[o].circleMarkers[0].setStyle(this.options.currentCircle),this._rubberlinePath2=i.polyline([],{color:this.options.tempLine.color,weight:this.options.tempLine.weight,interactive:!1,dashArray:"8,8"}).addTo(this._layerPaint).bringToBack(),this._tooltipNew=i.marker(currentCircleCoords,{icon:i.divIcon({className:"polyline-measure-tooltip",iconAnchor:[-4,-4]}),interactive:!1}),this._tooltipNew.addTo(this._layerPaint);var r="";!0===this.options.showBearings&&(r=r+this.options.bearingTextIn+":---\xb0<br>"+this.options.bearingTextOut+":---\xb0"),r+='<div class="polyline-measure-tooltip-difference">+0</div>',r+='<div class="polyline-measure-tooltip-total">0</div>',this._tooltipNew._icon.innerHTML=r,this._map.off("mousemove",this._mouseMove,this),this._map.on("mousemove",this._resumeFirstpointMousemove,this)}return}if(t.originalEvent.shiftKey){this._lineNr=t.target.cntLine;var o=this._lineNr;this._circleNr=t.target.cntCircle;var s=this._circleNr;if(this._layerPaint.hasLayer(this._rubberlinePath)&&o===this._currentLine.id){if(this._cntCircle--,1===this._currentLine.circleMarkers.length){this._currentLine.finalize();return}if(this._currentLine.circleCoords.splice(s,1),this._currentLine.circleMarkers[s].removeFrom(this._layerPaint),this._currentLine.circleMarkers.splice(s,1),this._currentLine.circleMarkers.map(function(i,t){i.cntCircle=t}),l=this._currentLine.polylinePath.getLatLngs(),this._currentLine.tooltips[s].removeFrom(this._layerPaint),this._currentLine.tooltips.splice(s,1),0===s){1===this._currentLine.circleMarkers.length?this._currentLine.circleMarkers[0].setStyle(this.options.currentCircle):this._currentLine.circleMarkers[0].setStyle(this.options.startCircle),l.splice(0,e-1),this._currentLine.circleMarkers[0].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._currentLine.arrowMarkers[s].removeFrom(this._layerPaint),this._currentLine.arrowMarkers.splice(0,1);var r="";!0===this.options.showBearings&&(r=this.options.bearingTextIn+":---\xb0<br>"+this.options.bearingTextOut+":---\xb0"),r+='<div class="polyline-measure-tooltip-difference">+0</div>',r+='<div class="polyline-measure-tooltip-total">0</div>',this._currentLine.tooltips[0]._icon.innerHTML=r}else s===this._currentLine.circleCoords.length?(this._currentLine.circleMarkers[s-1].on("click",this._resumePolylinePath,this),this._currentLine.circleMarkers[s-1].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._currentLine.circleMarkers.slice(-1)[0].setStyle(this.options.currentCircle),l.splice(-(e-1),e-1),this._currentLine.arrowMarkers[s-1].removeFrom(this._layerPaint),this._currentLine.arrowMarkers.splice(-1,1)):(a=this._polylineArc(this._currentLine.circleCoords[s-1],this._currentLine.circleCoords[s]),Array.prototype.splice.apply(l,[(s-1)*(e-1),2*e-1].concat(a)),this._currentLine.arrowMarkers[s-1].removeFrom(this._layerPaint),this._currentLine.arrowMarkers[s].removeFrom(this._layerPaint),c=this._drawArrow(a),this._currentLine.arrowMarkers.splice(s-1,2,c));this._currentLine.polylinePath.setLatLngs(l),this._currentLine.arrowMarkers.map(function(i,t){i.cntLine=o,i.cntArrow=t});var n=0;this._currentLine.tooltips.map((function(i,e,o){if(e>=1){var r,s,l=this._currentLine.tooltips[e-1],a=this._currentLine.circleCoords[e-1];e===o.length-1?(r=this._currentLine.circleCoords[e-1].distanceTo(t.latlng),s=t.latlng,this._updateTooltip(i,l,n+r,r,a,s)):(r=this._currentLine.circleCoords[e-1].distanceTo(this._currentLine.circleCoords[e]),s=this._currentLine.circleCoords[e],n+=r,this._updateTooltip(i,l,n,r,a,s))}}).bind(this)),this._currentLine.distance=n}else{if(2===this._arrPolylines[o].circleMarkers.length){this._layerPaint.removeLayer(this._arrPolylines[o].circleMarkers[1]),this._layerPaint.removeLayer(this._arrPolylines[o].tooltips[1]),this._layerPaint.removeLayer(this._arrPolylines[o].circleMarkers[0]),this._layerPaint.removeLayer(this._arrPolylines[o].tooltips[0]),this._layerPaint.removeLayer(this._arrPolylines[o].arrowMarkers[0]),this._layerPaint.removeLayer(this._arrPolylines[o].polylinePath),this._map.fire("polylinemeasure:remove",t),this._map.fire("polylinemeasure:change",this._arrPolylines[this._lineNr]);return}this._arrPolylines[o].circleCoords.splice(s,1),this._arrPolylines[o].circleMarkers[s].removeFrom(this._layerPaint),this._arrPolylines[o].circleMarkers.splice(s,1),this._arrPolylines[o].circleMarkers.map(function(i,t){i.cntCircle=t});var l=this._arrPolylines[o].polylinePath.getLatLngs();if(this._arrPolylines[o].tooltips[s].removeFrom(this._layerPaint),this._arrPolylines[o].tooltips.splice(s,1),!this._arrPolylines[o].circleMarkers.length){this._arrPolylines.splice(o,1),this._arrPolylines.forEach(function(i,t){i.circleMarkers.map(function(i){i.cntLine=t}),i.arrowMarkers.map(function(i){i.cntLine=t})});return}if(0===s){this._arrPolylines[o].circleMarkers[0].setStyle(this.options.startCircle),l.splice(0,e-1),this._arrPolylines[o].circleMarkers[0].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._arrPolylines[o].arrowMarkers[s].removeFrom(this._layerPaint),this._arrPolylines[o].arrowMarkers.splice(0,1);var r="";!0===this.options.showBearings&&(r=this.options.bearingTextIn+":---\xb0<br>"+this.options.bearingTextOut+":---\xb0"),r+='<div class="polyline-measure-tooltip-difference">+0</div>',r+='<div class="polyline-measure-tooltip-total">0</div>',this._arrPolylines[o].tooltips[0]._icon.innerHTML=r}else if(s===this._arrPolylines[o].circleCoords.length)this._arrPolylines[o].circleMarkers[s-1].on("click",this._resumePolylinePath,this),this._arrPolylines[o].circleMarkers[s-1].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:"top",opacity:.7,className:"polyline-measure-popupTooltip"}),this._arrPolylines[o].circleMarkers.slice(-1)[0].setStyle(this.options.endCircle),this._arrPolylines[o].tooltips.slice(-1)[0]._icon.classList.add("polyline-measure-tooltip-end"),l.splice(-(e-1),e-1),this._arrPolylines[o].arrowMarkers[s-1].removeFrom(this._layerPaint),this._arrPolylines[o].arrowMarkers.splice(-1,1);else{var a=this._polylineArc(this._arrPolylines[o].circleCoords[s-1],this._arrPolylines[o].circleCoords[s]);Array.prototype.splice.apply(l,[(s-1)*(e-1),2*e-1].concat(a)),this._arrPolylines[o].arrowMarkers[s-1].removeFrom(this._layerPaint),this._arrPolylines[o].arrowMarkers[s].removeFrom(this._layerPaint);var c=this._drawArrow(a);this._arrPolylines[o].arrowMarkers.splice(s-1,2,c)}this._arrPolylines[o].polylinePath.setLatLngs(l),this._arrPolylines[o].arrowMarkers.map(function(i,t){i.cntLine=o,i.cntArrow=t});var h=0;this._arrPolylines[o].tooltips.map((function(i,t){if(t>=1){var e=this._arrPolylines[o].circleCoords[t-1].distanceTo(this._arrPolylines[o].circleCoords[t]),r=this._arrPolylines[o].circleCoords[t-1],s=this._arrPolylines[o].circleCoords[t];h+=e,this._arrPolylines[o].distance=h;var n=this._arrPolylines[o].tooltips[t-1];this._updateTooltip(i,n,h,e,r,s)}}).bind(this))}this._map.fire("polylinemeasure:remove",t),this._map.fire("polylinemeasure:change",this._arrPolylines[this._lineNr]);return}this._e1=t,this._measuring&&0===this._cntCircle&&(this._map.dragging.disable(),this._map.off("mousemove",this._mouseMove,this),this._map.off("click",this._mouseClick,this),this._mouseStartingLat=t.latlng.lat,this._mouseStartingLng=t.latlng.lng,this._circleStartingLat=t.target._latlng.lat,this._circleStartingLng=t.target._latlng.lng,this._map.on("mousemove",this._dragCircleMousemove,this))},seed:function(t){t.forEach(t=>{this._toggleMeasure(),this._startLine(t[0]),t.forEach((e,o)=>{let r=i.latLng(e);this._mouseMove({latLng:r}),this._currentLine.addPoint(r),o===t.length-1&&(this._finishPolylinePath(),this._toggleMeasure())})})}}),i.Map.mergeOptions({PolylineMeasureControl:!1}),i.Map.addInitHook(function(){this.options.polylineMeasureControl&&(this.PMControl=new i.Control.PolylineMeasure,this.addControl(this.PMControl))}),i.control.polylineMeasure=function(t){return new i.Control.PolylineMeasure(t)},i.Control.PolylineMeasure});
